import http from '@ohos.net.http'
import router from '@ohos.router'

interface AntiqueItem {
  id: number;
  name: string;
  image: string;
  category: string;
}

@Component
export default struct Antique {
  @State searchText: string = ''
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State antiqueList: Array<AntiqueItem> = []

  private categories: Array<string> = ['å…¨éƒ¨', 'å”', 'å®‹', 'å…ƒ', 'æ˜', 'æ¸…', 'æ‚é¡¹']
  private categoryKeywordsMap: Record<string, Array<string>> = {
    'å”': ['å”', 'å”æœ', 'å”ä»£'],
    'å®‹': ['å®‹', 'å®‹æœ'],
    'å…ƒ': ['å…ƒ', 'å…ƒæœ'],
    'æ˜': ['æ˜', 'æ˜æœ'],
    'æ¸…': ['æ¸…', 'æ¸…æœ']
  }

  aboutToAppear() {
    this.fetchData()
  }

  fetchData(): void {
    let httpRequest = http.createHttp()
    httpRequest.request(
      'http://192.168.120.1:3000/api/antique/list',
      { method: http.RequestMethod.GET },
      (err, data) => {
        if (!err && typeof data.result === 'string') {
          this.antiqueList = JSON.parse(data.result)
        } else {
          console.error('è¯·æ±‚é”™è¯¯æˆ–æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', err)
        }
      }
    )
  }

  getFilteredList(): Array<AntiqueItem> {
    const search = this.searchText.trim().toLowerCase()

    return this.antiqueList.filter(item => {
      const nameMatch = item.name.toLowerCase().includes(search)

      const isInCategory = (() => {
        if (this.selectedCategory === 'å…¨éƒ¨') return true

        if (this.selectedCategory === 'æ‚é¡¹') {
          // æ‰€æœ‰ä¸å±äºå¸¸è§„åˆ†ç±»å…³é”®è¯çš„è§†ä¸ºæ‚é¡¹
          return !Object.values(this.categoryKeywordsMap).some(keywordList =>
          keywordList.some(keyword => item.category.includes(keyword))
          )
        }

        const keywords = this.categoryKeywordsMap[this.selectedCategory] || []
        return keywords.some(keyword => item.category.includes(keyword))
      })()

      return nameMatch && isInCategory
    })
  }

  build() {
    Column() {
      // âœ… å›ºå®šé¡¶éƒ¨ï¼šæœç´¢æ¡† + åˆ†ç±»æ ‡ç­¾
      // ğŸ” æœç´¢æ¡†åŒºåŸŸ
      Row() {
        Image($r('app.media.search_icon'))  // ä½ å¯ä»¥ç”¨ ğŸ” å›¾æ ‡çš„èµ„æºæ–‡ä»¶
          .width(20)
          .height(20)
          .margin({ left: 12, right: 8 })

        TextInput({
          placeholder: 'æœç´¢æ–‡ç‰©åç§°',
          text: this.searchText
        })
          .onChange(value => this.searchText = value)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
          .padding(8)
          .width('100%')
      }
      .height(40)
      .margin({ top: 16, left: 16, right: 16, bottom: 10 })
      .backgroundColor('#FFFFFF')
      .border({ width: 1, color: '#CCCCCC' })
      .borderRadius(8)
      .alignItems(VerticalAlign.Center)
      // åˆ†ç±»æ ‡ç­¾æ ï¼ˆæ¯é¡¹ï¼šå›¾æ ‡åœ¨ä¸Šï¼Œæ–‡å­—åœ¨ä¸‹ï¼‰
      Row({ space: 8 }) {
        ForEach(this.categories, (cat: string) => {
          Column() {
            Image(
              cat === 'å…¨éƒ¨' ? $r('app.media.tag_all') :
                cat === 'å”'   ? $r('app.media.tag_tang') :
                  cat === 'å®‹'   ? $r('app.media.tag_song') :
                    cat === 'å…ƒ'   ? $r('app.media.tag_yuan') :
                      cat === 'æ˜'   ? $r('app.media.tag_ming') :
                        cat === 'æ¸…'   ? $r('app.media.tag_qing') :
                        $r('app.media.tag_misc')
            )
              .width(25)
              .height(24)
              .margin({ bottom: 4 })

            Text(cat)
              .fontSize(12)
              .fontColor('#333333')
          }
          .width(39)
          .padding(8)
          .backgroundColor('#FFFFFF')
          .border({
            width: 2,
            color: this.selectedCategory === cat ? '#DAA520' : 'transparent'  // é€‰ä¸­æ—¶åŠ è¾¹æ¡†
          })
          .borderRadius(20)
          .onClick(() => this.selectedCategory = cat)
        },(cat:string)=>cat)
      }
      .margin({ left: 1, right: 1, bottom: 10 })

      // âœ… æ»šåŠ¨åŒºåŸŸï¼šæ–‡ç‰©å¡ç‰‡åˆ—è¡¨
      Scroll() {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
          ForEach(this.getFilteredList(), (item: AntiqueItem) => {
            Column() {
              Image(item.image)
                .width('100%')
                .aspectRatio(1)
                .objectFit(ImageFit.Cover)
                .borderRadius(10)

              Text(item.name)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ top: 6, bottom: 6 })
            }
            .width('48%')  // å®½åº¦ç•¥å°äº 50%ï¼Œç•™å‡ºé—´è·
            .padding(10)
            .backgroundColor('#FFFFFF')
            .borderRadius(10)
            .shadow({ radius: 3, color: '#cccccc', offsetX: 0, offsetY: 2 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/AntiqueDetail',
                params: {
                  item: JSON.stringify(item)  // ä¼ é€’å­—ç¬¦ä¸²åŒ–çš„å¯¹è±¡
                }
              })
            })
          })
        }
        .width('100%')
      }
      .margin({ bottom: 30 })
    }
    .align(Alignment.TopStart)
    .backgroundColor('#F7F8FA')
  }
}
