import router from "@ohos.router";

export { CommentItem, DynamicItem };
// è¯„è®ºæ•°æ®ç»“æ„
class CommentItem {
  id: number;
  user: string;
  content: string;
  time: string;

  constructor(id: number, user: string, content: string, time: string) {
    this.id = id;
    this.user = user;
    this.content = content;
    this.time = time;
  }
}

// åŠ¨æ€æ•°æ®ç»“æ„
class DynamicItem {
  id: number;
  avatar: Resource;
  username: string;
  content: string;
  time: string;
  likes: number;
  isLiked: boolean;
  images?: string[]; // æ›´æ–°ä¸º string[]
  comments: CommentItem[];

  constructor(
    id: number,
    avatar: Resource,
    username: string,
    content: string,
    time: string,
    likes: number,
    images?: string[],
    isLiked: boolean = false,
    comments: CommentItem[] = []
  ) {
    this.id = id;
    this.avatar = avatar;
    this.username = username;
    this.content = content;
    this.time = time;
    this.likes = likes;
    this.images = images;
    this.isLiked = isLiked;
    this.comments = comments;
  }
}

// ä¸´æ—¶æµ‹è¯•æ•°æ®
const mockData: DynamicItem[] = [
  new DynamicItem(
    1,
    $r('app.media.user_avatar1'),
    'è€ƒå¤çˆ±å¥½è€…',
    'ä»Šå¤©åœ¨æ•…å®«çœ‹åˆ°äº†è¿™ä»¶é’èŠ±ç“·ï¼Œé‡‰è‰²å¤ªç¾äº†ï¼',
    '2å°æ—¶å‰',
    15,
    [
      'app.media.dynamic_img1',
      'app.media.dynamic_img2'
    ],
    false,
    [
      new CommentItem(1, 'åšç‰©é¦†è¿·', 'è¿™ä»¶æ–‡ç‰©åœ¨å“ªä¸ªå±•å…ï¼Ÿ', '1å°æ—¶å‰'),
      new CommentItem(2, 'å†å²å­¦ç”Ÿ', 'é‡‰è‰²å·¥è‰ºç¡®å®ç²¾æ¹›ï¼', '30åˆ†é’Ÿå‰')
    ]
  ),
  new DynamicItem(
    2,
    $r('app.media.user_avatar2'),
    'å†å²ç ”ç©¶å‘˜',
    'åˆ†äº«ä¸€æœ¬å…³äºé’é“œå™¨çš„å¥½ä¹¦ï¼šã€Šä¸­å›½å¤ä»£é’é“œå™¨é‰´èµã€‹',
    '5å°æ—¶å‰',
    8,
    ['app.media.dynamic_img3'],
    true
  )
];

@Entry
@Component
struct UserDynamic {
  @StorageLink('dynamics') dynamics: DynamicItem[] = mockData
  aboutToAppear() {
    // åˆå§‹åŒ–åŠ è½½æ•°æ®
    if (!AppStorage.get('dynamics')) {
      AppStorage.setOrCreate('dynamics', mockData);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ç”¨æˆ·åŠ¨æ€')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Button('+ å‘å¸ƒ')
          .width(100)        // æ˜ç¡®æŒ‰é’®å°ºå¯¸
          .height(56)        // ç¬¦åˆMaterial Designè§„èŒƒ
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor('#ff0f0f10')
          .fontWeight(FontWeight.Bold)
          .borderRadius(28)  // æ¤­åœ†å½¢å‚æ•°ï¼ˆé«˜åº¦56æ—¶åŠå¾„28ï¼‰
          .onClick(() => {
            router.pushUrl({
              url: 'pages/DynamicPublish'
            })
          })
      }
      .padding(10)
      .width('100%')

      // åŠ¨æ€åˆ—è¡¨
      List({ space: 12 }) {
        ForEach(this.dynamics, (item: DynamicItem, index?: number) => {
          ListItem() {
            DynamicItemComponent({
              item: item,
              onLike: (isLiked: boolean) => {
                if (typeof index === 'number') {
                  this.dynamics[index] = new DynamicItem(
                    item.id,
                    item.avatar,
                    item.username,
                    item.content,
                    item.time,
                    isLiked ? item.likes - 1 : item.likes + 1,
                    item.images,
                    !isLiked,
                    item.comments // ğŸ‘ ä¿ç•™åŸæœ‰è¯„è®ºï¼Œä¸æ”¹åŠ¨
                  )

                }
              },
              onComment: (newComment: CommentItem) => {
                if (typeof index === 'number') {
                  const updatedItem = new DynamicItem(
                    item.id,
                    item.avatar,
                    item.username,
                    item.content,
                    item.time,
                    item.likes,
                    item.images,
                    item.isLiked,
                    [...item.comments, newComment] // ğŸ‘ˆ æ›´æ–°è¯„è®ºæ•°ç»„
                  )
                  this.dynamics[index] = updatedItem; // âœ… è§¦å‘å“åº”å¼æ›´æ–°
                  AppStorage.set('dynamics', this.dynamics); // âœ… æŒä¹…åŒ–å­˜å‚¨æ›´æ–°
                }
              }
            })
          }
          .padding(8)
        })
      }
      .width('100%')
      .layoutWeight(1)
      .divider({ strokeWidth: 0.5, color: '#eeeeee' })
    }
    .backgroundColor('#F8F8F8')
  }
  onPageShow() {
    const storedDynamics = AppStorage.get<DynamicItem[]>('dynamics');
    this.dynamics = storedDynamics ? [...storedDynamics] : []; // ä¿®æ­£å˜é‡åæ‹¼å†™
  }
}

@Component
struct DynamicItemComponent {
  @Prop item: DynamicItem
  private onLike: (isLiked: boolean) => void = () => {}
  private onComment: (comment: CommentItem) => void = () => {}
  @State showComments: boolean = false
  @State showCommentDialog: boolean = false
  @State commentText: string = ''

  build() {
    Column() {
      // å¡ç‰‡å®¹å™¨
      Column() {
        // ç”¨æˆ·ä¿¡æ¯
        Row() {
          Image(this.item.avatar)
            .width(48)
            .height(48)
            .borderRadius(24)
            .margin({ right: 12 })

          Column() {
            Text(this.item.username)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)

            Text(this.item.time)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 2 })
          }
          .alignItems(HorizontalAlign.Start)
        }
        .width('100%')

        // åŠ¨æ€å†…å®¹
        Text(this.item.content)
          .fontSize(15)
          .fontColor('#444444')
          .lineHeight(20)
          .margin({ top: 12, bottom: 8 })
          .width('100%')

        // å›¾ç‰‡å±•ç¤º
        if (this.item.images && this.item.images.length > 0) {
          Grid() {
            ForEach(this.item.images, (imgPath: string) => {
              GridItem() {
                // åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°å›¾ç‰‡è·¯å¾„
                if(this.getImagePath(imgPath)==false) {
                  Image($r(imgPath))// ä½¿ç”¨ $r å¤„ç†å­—ç¬¦ä¸²è·¯å¾„
                    //Image(this.getImagePath(imgPath)) // ç›´æ¥ä¼ é€’å¤„ç†åçš„è·¯å¾„
                    .width('100%')
                    .aspectRatio(1)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(8)
                    .transition({
                      type: TransitionType.All,
                      scale: { x: 0.95, y: 0.95 }
                    })
                }
                else{
                  Image(imgPath)// ä½¿ç”¨ $r å¤„ç†å­—ç¬¦ä¸²è·¯å¾„
                    //Image(this.getImagePath(imgPath)) // ç›´æ¥ä¼ é€’å¤„ç†åçš„è·¯å¾„
                    .width('100%')
                    .aspectRatio(1)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(8)
                    .transition({
                      type: TransitionType.All,
                      scale: { x: 0.95, y: 0.95 }
                    })
                }
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .rowsGap(6)
          .columnsGap(6)
          .margin({ top: 8 })
        }

        // äº’åŠ¨æŒ‰é’®
        Row() {
          // ç‚¹èµæŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Row() {
              Image($r('app.media.ic_like'))
                .width(20)
                .height(20)
                .fillColor(this.item.isLiked ? '#FF3A30' : '#666666')

              Text(this.item.likes.toString())
                .fontColor(this.item.isLiked ? '#FF3A30' : '#666666')
                .margin({ left: 4 })
            }
          }
          .onClick(() => {
            animateTo({
              duration: 200,
              curve: Curve.EaseInOut
            }, () => {
              this.onLike(this.item.isLiked)
            })
          })
          .backgroundColor(Color.Transparent)
          .padding(6)
          .margin({ right: 20 })

          // è¯„è®ºæŒ‰é’®
          Button({ type: ButtonType.Normal }) {
            Row() {
              Image($r('app.media.ic_comment'))
                .width(20)
                .height(20)
                .fillColor('#666666')

              Text('è¯„è®º')
                .fontColor('#666666')
                .margin({ left: 4 })
            }
          }
          .onClick(() => this.showCommentDialog = true)
          .backgroundColor(Color.Transparent)
          .padding(6)
        }
        .margin({ top: 12 })

        // è¯„è®ºåˆ—è¡¨
        if (this.showComments && this.item.comments.length > 0) {
          Column() {
            ForEach(this.item.comments, (comment: CommentItem) => {
              Column() {
                Row() {
                  Text(comment.user)
                    .fontColor('#007AFF')
                    .fontSize(14)

                  Text(comment.content)
                    .fontColor('#333333')
                    .fontSize(14)
                    .margin({ left: 8 })
                }
                .width('100%')

                Text(comment.time)
                  .fontSize(12)
                  .fontColor('#999999')
                  .margin({ top: 4 })
              }
              .padding(8)
            })
          }
          .margin({ top: 12 })
        }

        // å±•å¼€/æ”¶èµ·æŒ‰é’®
        if (this.item.comments.length > 0) {
          Text(this.showComments ? 'æ”¶èµ·è¯„è®º' : `æŸ¥çœ‹å…¨éƒ¨${this.item.comments.length}æ¡è¯„è®º`)
            .fontColor('#007AFF')
            .fontSize(12)
            .margin({ top: 8 })
            .onClick(() => this.showComments = !this.showComments)
        }
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 8, color: '#10000000', offsetX: 0, offsetY: 2 })

      // è¯„è®ºå¼¹çª—
      if (this.showCommentDialog) {

        Column() {
          // è‡ªå®šä¹‰è¾“å…¥æç¤º
          Text('å‘è¡¨è¯„è®º')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#222222')
            .margin({ bottom: 12 })

          TextArea({
            text: this.commentText,
            placeholder: 'è¯·è¾“å…¥ä½ çš„è¯„è®ºâ€¦',
          })
            .onChange((value: string) => {
              this.commentText = value
            })
            .width('100%')
            .height(120)
            .fontSize(16)
            .border({ width: 1, color: '#CCCCCC' })
            .borderRadius(10)
            .padding(10)
            .margin({ bottom: 20 })

          Row() {
            Button('å–æ¶ˆ')
              .width(130)
              .height(40)
              .backgroundColor('#DDDDDD')
              .fontColor('#333333')
              .borderRadius(20)
              .onClick(() => this.showCommentDialog = false)

            Button('å‘å¸ƒ')
              .width(130)
              .height(40)
              .backgroundColor('#007AFF')
              .fontColor('#ffffff')
              .borderRadius(20)
              .onClick(() => this.handleCommentSubmit())
          }
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .padding(24)
        .width('80%')
        .backgroundColor('#ffffff')
        .borderRadius(16)
        .shadow({ radius: 12, color: '#00000022', offsetX: 0, offsetY: 4 })
      }
    }
    .padding(10)
  }

  private handleCommentSubmit(): void {
    console.log("å‘å¸ƒè¯„è®ºæŒ‰é’®è¢«ç‚¹å‡»");
    if (this.commentText.trim()) {
      const newComment = new CommentItem(
        Date.now(),
        'å½“å‰ç”¨æˆ·',
        this.commentText,
        'åˆšåˆš'
      )
      if (this.onComment) {
        this.onComment(newComment) // ç¡®ä¿è°ƒç”¨ä¼ å…¥çš„å›è°ƒ
      }
      this.commentText = ''
      this.showCommentDialog = false // å…³é—­å¼¹çª—
      this.showComments = true   // è‡ªåŠ¨å±•å¼€è¯„è®ºåˆ—è¡¨
    }
  }
  // å›¾ç‰‡è·¯å¾„å¤„ç†å‡½æ•°
  private getImagePath(imgPath: string): boolean {
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶è·¯å¾„
    if (imgPath.startsWith('file://')) {
      return true; // å¦‚æœæ˜¯æ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥è¿”å›
    } else {
      return false; // å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    }
  }


}